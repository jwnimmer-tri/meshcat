<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>MeshCat</title>
	</head>
	<body>
        <div id="test-message">
          Test how the background interacts with the camera.

          Try the following:
            <ul>
              <li>Toggle the visibility of the Background control (or the Background object).</li>
              <li>Toggle the IsOrthographic, UseEnvironmentMap, and UseHDR controls.</li>
              <li>Change the Render Settings/&lt;object> exposure value.</object></li>
            </ul>
        </div>

        <div id="meshcat-pane">
        </div>

        <script src="../dist/main.min.js"></script>
        <script>

            // Texture of the cornell box environment as a small (256x128) equirectangular map.
            let env_map_hdr = 'env_256_cornell_box.hdr';
            let env_map_png = 'env_256_cornell_box.png';
            // use_hdr defaults to false; so env map defaults to png.
            let env_map = env_map_png;

            var viewer = new MeshCat.Viewer(document.getElementById("meshcat-pane"));
            try {
                viewer.connect();
            } catch (e) {
                console.info("Not connected to MeshCat websocket server: ", e);
            }
            viewer.set_property(['Background', "<object>"], "top_color", [1, 0, 0]);
            viewer.set_property(['Lights'], 'visible', false);
            viewer.set_property(['Render Settings', '<object>'], "exposure", 0.25);

            viewer.handle_command({
                type: "set_object",
                path: "/meshcat/mesh_test",
                object: {
                    metadata: {version: 4.5, type: "Object"},
                    geometries: [{
                        uuid: "cef79e52-526d-4263-b595-04fa2705974e",
                        type: "SphereGeometry",
                        radius: 0.5,
                    }],
                    materials: [
                        {
                            uuid: "0767ae32-eb34-450c-b65f-3ae57a1102c3",
                            type: "MeshPhysicalMaterial",
                            color: 16777215,
                            roughness: 0.935,
                            metalness: 0.5,
                            side: 2,
                            depthFunc: 3,
                            depthTest: true,
                            depthWrite: true
                        }
                    ],
                    object: {
                        uuid: "00c2baef-9600-4c6b-b88d-7e82c40e004f",
                        type: "Mesh",
                        geometry: "cef79e52-526d-4263-b595-04fa2705974e",
                        material: "0767ae32-eb34-450c-b65f-3ae57a1102c3",
                    }
                }
            });

            var message_dom = document.getElementById("test-message");

            var background_visible = true;
            var has_environment_map = false;
            var use_hdr = false;
            var is_orthographic = false;

            let update_message = () => {
                if (background_visible) {
                    if (is_orthographic) {
                        message_dom.innerText =
                            "Orthographic cameras display only render \
                            background gradients (if Background is visible) or \
                            white if invisible. The gradient is always mapped \
                            to the screen; the top color rendered at the top \
                            of the screen, the bottom color at the bottom of \
                            the screen, regardless of orientation.";
                        if (has_environment_map) {
                            message_dom.innerText +=
                                "\n\nOrthographic cameras will never display \
                                environment maps. The environment map will \
                                still contribute to the illumination of \
                                objects with PBR materials.";
                        }
                    } else {
                        if (has_environment_map) {
                            message_dom.innerText =
                                "Perspective cameras will display the \
                                environment map so long as \
                                \\Background\\<object>'s render_environment_map \
                                is true. The map is rendered as a surrounding \
                                environment map. The map will contribute to \
                                the illumination of objects with PBR materials."
                            if (use_hdr) {
                                message_dom.innerText +=
                                    "\n\nThe environment map is an HDR image \
                                    with a high-intensity overhead light. The \
                                    ball is much brighter than it is with the \
                                    PNG environment map.";
                            } else {
                                message_dom.innerText +=
                                    "\n\nThe environment map is a PNG image. \
                                    The light intensity is relatively dim. \
                                    Toggling to use HDR will increase the \
                                    amount of luminant energy in the \
                                    environment map and, therefore, the scene.";
                            }
                        } else {
                            message_dom.innerText =
                                "Perspective cameras will display the visible \
                                background gradient (if it is visible) as a \
                                surrounding environment map. The gradient \
                                will contribute to the illumination of objects \
                                with PBR materials."
                        }
                    }
                } else {
                    message_dom.innerText =
                        "When the background isn't visible, a white screen is \
                        rendered as background and in the environment map, \
                        regardless of camera projection type or definition of \
                        an environment map. The white field still serves as \
                        environment map, so the sphere should be brightly lit."
                }
                message_dom.innerText +=
                    "\n\nIf you open the controls to 'Render Settings\\<object>' \
                    you can control the lighting exposure of the scene. Lower \
                    exposure will reduce the total lighting energy (making the \
                    sphere darker) and higher values increase the lighting \
                    intensity.";
            }

            // We're going to hijack the Background.update() method so we can
            // detect when the visibility of the background is toggled and
            // amend the message text accordingly.
            bg = viewer.scene_tree.find(["Background", "<object>"]).object;
            var bg_update = bg.update;
            bg.update = (scene, is_visible, is_perspective) => {
                if (background_visible !== is_visible) {
                    background_visible = is_visible;
                    update_message();
                }
                bg_update.call(bg, scene, is_visible, is_perspective, () => { viewer.set_dirty(); });
            };

            // Allow the user to play with orthographic cameras and environment
            // maps dynamically.
            var toggle_orthographic = () => {
                is_orthographic = !is_orthographic;
                if (is_orthographic) {
                    viewer.handle_command({
                        type: "set_object",
                        path: "/Cameras/default/rotated",
                        object: {
                            object: {
                                type: "OrthographicCamera",
                                zoom: 1,
                                left: -10,
                                right: 10,
                                top: 10,
                                bottom: -10,
                                near: -1000,
                                far: 1000
                            }
                        }
                    });
                } else {
                    viewer.handle_command({
                        type: "set_object",
                        path: "/Cameras/default/rotated",
                        object: {
                            object: {
                                type: "PerspectiveCamera",
                                fov: 75,
                                aspect: 1,
                                near: 0.01,
                                far: 200
                            }
                        }
                    });
                }
                viewer.set_camera_target([0, 0, 0]);
                viewer.set_transform(['Cameras', 'default'], [1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1]);
                viewer.set_property(["Cameras", "default", "rotated", "<object>"], "position", [0, 1, 3]);
                update_message();
            };
            viewer.set_control("IsOrthographic", toggle_orthographic, false);


            var toggle_env_map = () => {
                has_environment_map = !has_environment_map;
                if (has_environment_map) {
                    viewer.set_property(["Background", "<object>"], "environment_map", env_map);
                } else {
                    viewer.set_property(["Background", "<object>"], "environment_map", "");
                }
                update_message();
            };
            viewer.set_control("UseEnvironmentMap", toggle_env_map, false);

            var toggle_hdr = () => {
                use_hdr = !use_hdr;
                if (use_hdr) {
                    env_map = env_map_hdr;
                } else {
                    env_map = env_map_png;
                }
                if (has_environment_map) {
                    viewer.set_property(["Background", "<object>"], "environment_map", env_map);
                }
                update_message();
            };
            viewer.set_control("UseHDR", toggle_hdr, false);
        </script>


         <style>
            body {
                margin: 0;
            }

            #meshcat-pane {
                width: 100vw;
                height: 100vh;
                overflow: hidden;
            }

            #test-message{
                width: 75vw;
                text-align: left;
                background-color: rgb(232, 232, 232);
                position: fixed;
                left: 0%;
                display: block;
                padding: 10px;
            }
        </style>
        <script id="embedded-json"></script>
	</body>
</html>
